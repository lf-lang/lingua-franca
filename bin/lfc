#!/bin/bash

#==========================================================
# Description: 	    Run the lfc compiler.
# Authors:          Marten Lohstroh
# Usage:            Usage: lfc [options] files...
#==========================================================

set -euo pipefail
base=""
if [ ! "$0" = "${0##*/*}" ]; then  # Do we have a parent directory?
	base="${0%/*}/"
fi
base="${base}../"
lfbase="${base}org.lflang.lfc/"
jarpath="${lfbase}build/libs/org.lflang.lfc-0.1.0-SNAPSHOT-all.jar"

# Report fatal error.
function fatal_error() {
    1>&2 echo -e "\e[1mlfc: \e[31mfatal error: \e[0m$1"
    exit 1
}

pushd () {
    command pushd "$@" > /dev/null
}

popd () {
    command popd "$@" > /dev/null
}

# 1. Determine whether to rebuild; and
# 2. Strip rebuild flag from args.
rebuild=false
args=()
for var in "$@"; do
    # remove leading whitespace characters
    var="${var#"${var%%[![:space:]]*}"}"
    # remove trailing whitespace characters
    var="${var%"${var##*[![:space:]]}"}"
    if [[ $var = "-r" ]]; then
        rebuild=true
    else
        args+=("$var")
    fi
done

# Build if no jar exists or rebuild is requested.
if [[ ! -f "$jarpath" || "$rebuild" = true ]]; then
    # Throw error if no sources are available
    if [[ -z $lfbase || ! -d $lfbase ]]; then
        fatal_error "Unable to (re)build from source. Exiting."
    fi
    pushd "$base"
    ./gradlew buildLfc
    popd
fi

if [[ $(type -p java) != "" ]]; then
    #echo found java executable in PATH
    _java=java
elif [[ -n "$JAVA_HOME" ]] && [[ -x "$JAVA_HOME/bin/java" ]];  then
    #echo found java executable in JAVA_HOME     
    _java="$JAVA_HOME/bin/java"
else
    fatal_error "JRE not found."
fi

if [[ "$_java" ]]; then
    semantic_version=$("$_java" -version 2>&1 | awk -F '"' '/version/ {print $2}')
    java_version=$(echo "$semantic_version" | awk -F. '{printf("%03d%03d",$1,$2);}')
    #echo version "$semantic_version"
    #echo version "$java_version"
    if [ $java_version -lt 011000 ]; then
        fatal_error "JRE $semantic_version found but 1.11 or greater is required."
    fi
fi

"${_java}" -jar "${jarpath}" "${args[@]}";
exit $?
