name: Check diff from master

on:
  workflow_call:
    outputs:
      build_anyway:
        description: 'Return true if building is still needed when skipping tests'
        value: ${{ jobs.check.outputs.build_anyway == 1 }}
      run_c:
        description: 'Return true if C tests should be run'
        value: ${{ jobs.check.outputs.changed_c == 1 && jobs.check.outputs.skip_all != 'true' }}
      run_cpp:
        description: 'Return true if C++ tests should be run'
        value: ${{ jobs.check.outputs.changed_cpp == 1 && jobs.check.outputs.skip_all != 'true' }}
      run_py:
        description: 'Return true if Python tests should be run'
        value: ${{ (jobs.check.outputs.changed_py == 1 || jobs.check.outputs.changed_c == 1) && jobs.check.outputs.skip_all != 'true' }}
      run_rs:
        description: 'Return true if Rust tests should be run'
        value: ${{ jobs.check.outputs.changed_rs == 1 && jobs.check.outputs.skip_all != 'true' }}
      run_ts:
        description: 'Return true if TypeScript tests should be run'
        value: ${{ jobs.check.outputs.changed_ts == 1 && jobs.check.outputs.skip_all != 'true' }}
      run_tracing:
        description: 'Return true if tracing tests should be run'
        value: ${{ jobs.check.outputs.changed_tracing == 1 && jobs.check.outputs.skip_all != 'true' }}
      skip_all:
        description: 'Return true if tests should not be run'
        value: ${{ jobs.check.outputs.skip_all == 'true' }}

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      build_anyway: ${{ steps.skip-ignore.outputs.changed_build }}  
      changed_c: ${{ steps.do.outputs.changed_c }}
      changed_cpp: ${{ steps.do.outputs.changed_cpp }}
      changed_py: ${{ steps.do.outputs.changed_py }}
      changed_rs: ${{ steps.do.outputs.changed_rs }}
      changed_ts: ${{ steps.do.outputs.changed_ts }}
      changed_tracing: ${{ steps.do.outputs.changed_tracing }}
      skip_all: ${{ steps.duplicate.outputs.should_skip == 'true' && steps.do.outputs.changed_any == 0 }}
    steps:
      - name: Check out lingua-franca repository
        uses: actions/checkout@v3
        with:
          repository: lf-lang/lingua-franca
          submodules: true
          fetch-depth: 0
      - name: Check for redundant runs
        id: duplicate
        uses: fkirc/skip-duplicate-actions@v5.3.0
      - id: do
        name: Check which targets have changes
        run: |
          ./check-diff.sh "lflang/generator/c\|resources/lib/c\|resources/lib/platform\|test/C" c
          ./check-diff.sh "lflang/generator/cpp\|resources/lib/cpp\|test/Cpp" cpp
          ./check-diff.sh "lflang/generator/python\|resources/lib/py\|test/Python" py
          ./check-diff.sh "lflang/generator/rust\|resources/lib/rs\|test/Rust" rs
          ./check-diff.sh "lflang/generator/ts\|resources/lib/ts\|test/TypeScript" ts
          ./check-diff.sh "util/tracing" tracing
          ./check-diff.sh "" any
        shell: bash
        working-directory: .github/scripts
      - id: summarize
        name: "Create summary"
        run: |
          echo '## Summary' > $GITHUB_STEP_SUMMARY
      - id: skip-redundant
        name: "Explain skipping all checks due to a prior run"
        run: |
          echo ":tada: A successful prior run has been found:" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.duplicate.outputs.skipped_by }}" >> $GITHUB_STEP_SUMMARY
          echo ":heavy_check_mark: Skipping all tests." >> $GITHUB_STEP_SUMMARY
        if: ${{ steps.do.outputs.skip_all == 'true' }}
      - id: skip-ignore
        name: "Explain skipping all checks due to inconsequential changes"
        run: |
          echo "The detected changes did not affect any code." >> $GITHUB_STEP_SUMMARY
          echo ":heavy_check_mark: Skipping tests. Only running build." >> $GITHUB_STEP_SUMMARY
          echo "build_anyway=1" >> $GITHUB_OUTPUT
        if: ${{ steps.do.outputs.skip_all != 'true' && steps.do.outputs.changed_any == 0 }}
      - id: run-some
        name: "Explain running some checks"
        run: |
          echo ":hourglass: No successful prior run has been found." >> $GITHUB_STEP_SUMMARY
        if: ${{ steps.do.outputs.skip_all != 'true' }}
      - id: ready-mode
        name: 'Report on full test run'
        run: |
          echo ":heavy_check_mark: Performing all tests." >> $GITHUB_STEP_SUMMARY
        if: ${{ !github.event.pull_request.draft }}
      - id: draft-mode
        name: 'Report on partial test run'
        run: |
          echo ":heavy_check_mark: Performing tests affected by detected changes." >> $GITHUB_STEP_SUMMARY
          echo '|         | running                                   |' >> $GITHUB_STEP_SUMMARY
          echo '|---------|-------------------------------------------|' >> $GITHUB_STEP_SUMMARY
          echo '| c       | `${{ steps.do.outputs.changed_c == 1 }}`       |' >> $GITHUB_STEP_SUMMARY
          echo '| cpp     | `${{ steps.do.outputs.changed_cpp == 1 }}`     |' >> $GITHUB_STEP_SUMMARY
          echo '| py      | `${{ steps.do.outputs.changed_py == 1 }}`      |' >> $GITHUB_STEP_SUMMARY
          echo '| rs      | `${{ steps.do.outputs.changed_rs == 1 }}`      |' >> $GITHUB_STEP_SUMMARY
          echo '| ts      | `${{ steps.do.outputs.changed_ts == 1 }}`      |' >> $GITHUB_STEP_SUMMARY
          echo '| tracing | `${{ steps.do.outputs.changed_tracing == 1 }}` |' >> $GITHUB_STEP_SUMMARY
        if: ${{ github.event.pull_request.draft }}
